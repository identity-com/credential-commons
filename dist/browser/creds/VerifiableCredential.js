"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_=require("lodash"),validUrl=require("valid-url"),sift=require("sift").default,timestamp=require("unix-timestamp"),flatten=require("flat"),uuidv4=require("uuid/v4"),MerkleTools=require("merkle-tools"),_require=require("../lib/crypto"),sha256=_require.sha256,_require2=require("../claim/Claim"),Claim=_require2.Claim,definitions=require("./definitions"),_require3=require("../services"),services=_require3.services,time=require("../timeHelper"),_require4=require("./CvcMerkleProof"),CvcMerkleProof=_require4.CvcMerkleProof,_require5=require("./ClaimModel"),ClaimModel=_require5.ClaimModel,CredentialSignerVerifier=require("./CredentialSignerVerifier"),_require6=require("../schemas/jsonSchema"),schemaLoader=_require6.schemaLoader,convertDeltaToTimestamp=function(a){return time.applyDeltaToDate(a).getTime()/1e3};function validIdentifiers(){var a=_.map(definitions,function(a){return a.identifier});return a}function getClaimsWithFlatKeys(a){var b=flatten(a,{maxDepth:3}),c=flatten(a,{maxDepth:2}),d=_.merge({},b,c);return _(d).toPairs().sortBy(0).fromPairs().value()}function getLeavesClaimPaths(a){return _.map(a,"claimPath")}function verifyLeave(a,b,c,d,e,f,g){var h=new Claim(a.identifier,{attestableValue:a.value});if("String"===h.type||"Number"===h.type)h.value!==_.get(c,a.claimPath)&&e.push(a.value);else if("Object"===h.type){var i=h.value,j=_.get(c,a.claimPath),k=_.last(_.split(a.claimPath,".")),l={};l[k]=j;var m=_.keys(h.value);_.each(m,function(a){var b=_.get(l,a);b&&"".concat(_.get(i[a],"value"))!=="".concat(b)&&e.push(l[a])})}else if("Array"===h.type){var n=_.get(c,a.claimPath);_.forEach(h.value,function(a,b){var c=n[b],d=_.keys(a.value);_.each(d,function(b){var d=_.get(c,b);d&&"".concat(_.get(a.value,[b,"value"]))!=="".concat(d)&&e.push(c[b])})})}else e.push(a.value);var o=sha256(a.value);o!==a.targetHash&&f.push(a.targetHash);var p=b.validateProof(a.node,a.targetHash,d.merkleRoot);p||g.push(a.targetHash)}function validateEvidence(a){if(_.forEach(["type","verifier","evidenceDocument","subjectPresence","documentPresence"],function(b){if(!(b in a))throw new Error("Evidence ".concat(b," is required"))}),"id"in a&&!validUrl.isWebUri(a.id))throw new Error("Evidence id is not a valid URL");if(!_.isArray(a.type))throw new Error("Evidence type is not an Array object")}function serializeEvidence(a){var b=_.isArray(a)?a:[a];return _.map(b,function(a){return validateEvidence(a),{id:a.id,type:a.type,verifier:a.verifier,evidenceDocument:a.evidenceDocument,subjectPresence:a.subjectPresence,documentPresence:a.documentPresence}})}function transformConstraint(a){var b=[];return _.forEach(a.claims,function(a){if(!a.path)throw new Error("Malformed contraint: missing PATTH");if(!a.is)throw new Error("Malformed contraint: missing IS");var c={};c[a.path]=a.is,b.push(c)}),b}function isDateStructure(a){var b=_.keys(a);return!(3!==b.length)&&_.includes(b,"day")&&_.includes(b,"month")&&_.includes(b,"year")}function nonCryptographicallySecureVerify(){return _nonCryptographicallySecureVerify.apply(this,arguments)}function _nonCryptographicallySecureVerify(){return _nonCryptographicallySecureVerify=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,schemaLoader.loadSchemaFromTitle("cvc:Meta:expirationDate");case 2:return a.next=4,schemaLoader.loadSchemaFromTitle(b.identifier);case 4:return c=_.clone(b.expirationDate),d=_.clone(b.claim),e=_.clone(b.proof),f=_.get(e,"leaves"),g=!1,h=new MerkleTools,i=getClaimsWithFlatKeys(d),j=getLeavesClaimPaths(f),k=[],l=[],m=[],n=[],o=[],_.forEach(_.keys(i),function(a){var b=_.indexOf(j,a);if(-1===b){_.findLastIndex(a,".");var c=a.substring(0,_.lastIndexOf(a,"."));if(-1<_.indexOf(j,c))return;k.push(a)}else{var g=f[b];verifyLeave(g,h,d,e,m,n,o)}}),p=_.indexOf(j,"meta.expirationDate"),0<=p&&(q=f[p],r={meta:{expirationDate:c}},s=m.length+n.length+o.length,verifyLeave(q,h,r,e,m,n,o),t=m.length+n.length+o.length,t===s&&null!==c&&(u=new Date,v=new Date(c),u.getTime()>v.getTime()&&l.push(c))),_.isEmpty(k)&&_.isEmpty(m)&&_.isEmpty(n)&&_.isEmpty(o)&&_.isEmpty(l)&&(g=!0),a.abrupt("return",g);case 22:case"end":return a.stop();}},a)})),_nonCryptographicallySecureVerify.apply(this,arguments)}function cryptographicallySecureVerify(){return _cryptographicallySecureVerify.apply(this,arguments)}function _cryptographicallySecureVerify(){return _cryptographicallySecureVerify=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c,d){var e,f,g;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,nonCryptographicallySecureVerify(b);case 2:if(e=a.sent,e){a.next=5;break}return a.abrupt("return",!1);case 5:if(!c){a.next=11;break}return a.next=8,c(b.proof);case 8:if(f=a.sent,f){a.next=11;break}return a.abrupt("return",!1);case 11:if(!d){a.next=17;break}return a.next=14,d(b.proof);case 14:if(g=a.sent,g){a.next=17;break}return a.abrupt("return",!1);case 17:return a.abrupt("return",!0);case 18:case"end":return a.stop();}},a)})),_cryptographicallySecureVerify.apply(this,arguments)}function requesterGrantVerify(a,b,c,d){var e=_.get(a.proof,"anchor.subject.label"),f=_.get(a.proof,"anchor.subject.pub"),g=_.get(a.proof,"anchor.subject.data");if(_.isEmpty(a.granted)||_.isEmpty(e)||_.isEmpty(f))return!1;var h="".concat(e).concat(g).concat(b).concat(c),i=sha256(h),j=services.container.CryptoManager,k=d;if(_.isEmpty(k)){if(!_.isFunction(j.installKey))throw new Error("CryptoManager does not support installKey, please use a `keyName` instead.");k="TEMP_KEY_NAME_".concat(new Date().getTime()),j.installKey(k,f)}return j.verify(k,i,a.granted)}function transformDate(a){return new Date(a.year,a.month-1,a.day).getTime()/1e3}var VERIFY_LEVELS={INVALID:-1,PROOFS:0,ANCHOR:1,GRANTED:2,BLOCKCHAIN:3};function verifyRequiredClaims(a,b){if(!_.isEmpty(a.required)){var c=b.map(function(a){return a.identifier}),d=_.difference(a.required,c);if(!_.isEmpty(d))throw new Error("Missing required claim(s): ".concat(_.join(d,", ")))}}function verifyRequiredClaimsFromJSON(a,b){var c=_.get(b,"proof.leaves");if(!_.isEmpty(a.required)&&c){var d=c.map(function(a){return a.identifier}),e=_.difference(a.required,d);if(!_.isEmpty(e))throw new Error("Missing required claim(s): ".concat(_.join(e,", ")))}}function getCredentialDefinition(a,b){var c;if(c=b?_.find(definitions,{identifier:a,version:"".concat(b)}):_.find(definitions,{identifier:a}),!c)throw new Error("Credential definition for ".concat(a," v").concat(b," not found"));return c}function VerifiableCredentialBaseConstructor(a,b,c,d,e,f){var g=this,h=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null;this.id=uuidv4(),this.issuer=b;var i=new Claim("cvc:Meta:issuer",this.issuer);this.issuanceDate=new Date().toISOString();var j=new Claim("cvc:Meta:issuanceDate",this.issuanceDate);this.identifier=a,this.expirationDate=c?timestamp.toDate(timestamp.now(c)).toISOString():null;var k=new Claim("cvc:Meta:expirationDate",this.expirationDate?this.expirationDate:"null"),l=k?_.concat(d,i,j,k):_.concat(d,i,j);if(!_.includes(validIdentifiers(),a))throw new Error("".concat(a," is not defined"));var m=getCredentialDefinition(a,e);if(this.version="".concat(e)||m.version,this.type=["Credential",a],this.transient=m.transient||!1,f&&(this.evidence=serializeEvidence(f)),!_.isEmpty(d)){if(verifyRequiredClaims(m,d),this.claim=new ClaimModel(d),this.proof=new CvcMerkleProof(l,h),!_.isEmpty(m.excludes)){var n=_.remove(this.proof.leaves,function(a){return _.includes(m.excludes,a.identifier)});_.forEach(n,function(a){_.unset(g.claim,a.claimPath)})}this.granted=null}this.getGlobalIdentifier=function(){return"credential-".concat(g.identifier,"-").concat(g.version)},this.filter=function(a){var b=_.cloneDeep(g);return _.remove(b.proof.leaves,function(b){return!_.includes(a,b.identifier)}),b.claim={},_.forEach(b.proof.leaves,function(a){_.set(b.claim,a.claimPath,_.get(g.claim,a.claimPath))}),b},this.requestAnchor=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!g.transient){a.next=3;break}return g.proof.anchor={type:"transient",subject:{label:g.identifier,data:g.proof.merkleRoot}},a.abrupt("return",g);case 3:return c=services.container.AnchorService,d=_.merge({},b,{subject:{label:g.identifier,data:g.proof.merkleRoot}}),a.next=7,c.anchor(d);case 7:return e=a.sent,g.proof.anchor=e,a.abrupt("return",g);case 10:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),this.updateAnchor=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(){var b,c;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!g.transient){a.next=3;break}return g.proof.anchor={type:"transient",subject:{label:g.identifier,data:g.proof.merkleRoot}},a.abrupt("return",g);case 3:return b=services.container.AnchorService,a.next=6,b.update(g.proof.anchor);case 6:return c=a.sent,g.proof.anchor=c,a.abrupt("return",g);case 9:case"end":return a.stop();}},a)})),this.verifyProofs=function(){return nonCryptographicallySecureVerify(g)},this.verify=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d,e,f,h,i,j;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(d=c||{},e=d.requestorId,f=d.requestId,h=d.keyName,i=_.isNil(b)?VERIFY_LEVELS.GRANTED:b,j=VERIFY_LEVELS.INVALID,a.t0=j===VERIFY_LEVELS.INVALID&&i>=VERIFY_LEVELS.PROOFS,!a.t0){a.next=8;break}return a.next=7,g.verifyProofs();case 7:a.t0=a.sent;case 8:if(!a.t0){a.next=10;break}j=VERIFY_LEVELS.PROOFS;case 10:return j===VERIFY_LEVELS.PROOFS&&i>=VERIFY_LEVELS.ANCHOR&&g.verifyAttestation()&&(j=VERIFY_LEVELS.ANCHOR),j===VERIFY_LEVELS.ANCHOR&&i>=VERIFY_LEVELS.GRANTED&&g.verifyGrant(e,f,h)&&(j=VERIFY_LEVELS.GRANTED),a.abrupt("return",j);case 13:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),this.verifyAnchorSignature=function(a){return"transient"===g.proof.anchor.type||services.container.AnchorService.verifySignature(g.proof,a)},this.verifyMerkletreeSignature=function(a){if(_.isEmpty(a))return!1;var b=new CredentialSignerVerifier({pubBase58:a});return b.isSignatureValid(g)},this.verifyAttestation=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("transient"!==g.proof.anchor.type&&"dummynet"!==g.proof.anchor.network){a.next=2;break}return a.abrupt("return",!0);case 2:return a.abrupt("return",services.container.AnchorService.verifyAttestation(g.proof));case 3:case"end":return a.stop();}},a)})),this.revokeAttestation=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("transient"!==g.proof.type){a.next=2;break}return a.abrupt("return");case 2:return a.abrupt("return",services.container.AnchorService.revokeAttestation(g.proof));case 3:case"end":return a.stop();}},a)})),this.isRevoked=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("transient"!==g.proof.type){a.next=2;break}return a.abrupt("return",!1);case 2:return a.abrupt("return",services.container.AnchorService.isRevoked(g.proof));case 3:case"end":return a.stop();}},a)}));var o=function(a){return _.isString(a)?convertDeltaToTimestamp(a):a};return this.isMatch=function(a){var b=_.cloneDeep(g.claim),c=transformConstraint(a),d=function(a){var c=_.keys(a)[0],d=_.get(b,c);return isDateStructure(d)&&(_.set(b,c,transformDate(d)),_.set(a,c,_.mapValues(a[c],o))),sift(a)([b])};return c.reduce(function(a,b){return a&&d(b)},!0)},this.grantUsageFor=function(a,b,c){var d=c.keyName,e=c.pvtKey;if(_.isEmpty(_.get(g.proof,"anchor.subject.label"))||_.isEmpty(_.get(g.proof,"anchor.subject.data")))throw new Error("Invalid credential attestation/anchor");if(!g.verifyAnchorSignature())throw new Error("Invalid credential attestation/anchor signature");if(!a||!b||!(d||e))throw new Error("Missing required parameter: requestorId, requestId or key");var f="".concat(g.proof.anchor.subject.label).concat(g.proof.anchor.subject.data).concat(a).concat(b),h=sha256(f),i=services.container.CryptoManager,j=d;if(e){if(!_.isFunction(i.installKey))throw new Error("You provide a `pvtKey` but the CryptoManager does not support it, use a `keyName` instead.");j="TEMP_KEY_NAME_".concat(new Date().getTime()),i.installKey(j,e)}var k=i.sign(j,h);g.granted=k},this.verifyGrant=function(a,b,c){return requesterGrantVerify(g,a,b,c)},this}var CREDENTIAL_META_FIELDS=["id","identifier","issuer","issuanceDate","expirationDate","version","type"],getCredentialMeta=function(a){return _.pick(a,CREDENTIAL_META_FIELDS)};function transformMetaConstraint(a){var b=[],c=_.keys(a.meta);return _.forEach(c,function(c){var d=a.meta[c],e={};if("credential"===c)e.identifier=d;else if(d.is)e[c]=d.is;else throw new Error("Malformed meta constraint \"".concat(c,"\": missing the IS"));b.push(e)}),b}var isMatchCredentialMeta=function(a,b){var c=transformMetaConstraint(b);if(_.isEmpty(c))return!1;var d=function(b){return sift(b)([a])};return c.reduce(function(a,b){return a&&d(b)},!0)};VerifiableCredentialBaseConstructor.CREDENTIAL_META_FIELDS=CREDENTIAL_META_FIELDS,VerifiableCredentialBaseConstructor.getCredentialMeta=getCredentialMeta,VerifiableCredentialBaseConstructor.isMatchCredentialMeta=isMatchCredentialMeta,VerifiableCredentialBaseConstructor.create=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c,d,e,f,g){var h,i=arguments;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return h=6<i.length&&void 0!==i[6]?i[6]:null,a.next=3,schemaLoader.loadSchemaFromTitle(b);case 3:return a.next=5,schemaLoader.loadSchemaFromTitle("cvc:Meta:issuer");case 5:return a.next=7,schemaLoader.loadSchemaFromTitle("cvc:Meta:issuanceDate");case 7:return a.next=9,schemaLoader.loadSchemaFromTitle("cvc:Meta:expirationDate");case 9:return a.next=11,schemaLoader.loadSchemaFromTitle("cvc:Random:node");case 11:return a.abrupt("return",new VerifiableCredentialBaseConstructor(b,c,d,e,f,g,h));case 12:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialBaseConstructor.fromJSON=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e,f=arguments;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=!!(1<f.length&&void 0!==f[1])&&f[1],a.next=3,schemaLoader.loadSchemaFromTitle(b.identifier);case 3:return d=getCredentialDefinition(b.identifier,b.version),c||verifyRequiredClaimsFromJSON(d,b),a.next=7,VerifiableCredentialBaseConstructor.create(b.identifier,b.issuer);case 7:return e=a.sent,e.id=_.clone(b.id),e.issuanceDate=_.clone(b.issuanceDate),e.expirationDate=_.clone(b.expirationDate),e.identifier=_.clone(b.identifier),e.version=_.clone(b.version),e.type=_.cloneDeep(b.type),e.claim=_.cloneDeep(b.claim),e.proof=_.cloneDeep(b.proof),e.granted=_.clone(b.granted)||null,a.abrupt("return",e);case 18:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialBaseConstructor.getAllProperties=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,schemaLoader.loadSchemaFromTitle(b);case 2:if(c=_.find(definitions,{identifier:b}),!c){a.next=13;break}return a.next=6,c.depends.reduce(function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d,e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b;case 2:return d=a.sent,a.next=5,Claim.getAllProperties(c);case 5:return e=a.sent,a.abrupt("return",[].concat((0,_toConsumableArray2.default)(d),(0,_toConsumableArray2.default)(e)));case 7:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Promise.resolve([]));case 6:if(d=a.sent,e=[],!c.excludes){a.next=12;break}return a.next=11,c.excludes.reduce(function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d,e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b;case 2:return d=a.sent,a.next=5,Claim.getAllProperties(c);case 5:return e=a.sent,a.abrupt("return",[].concat((0,_toConsumableArray2.default)(d),(0,_toConsumableArray2.default)(e)));case 7:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Promise.resolve([]));case 11:e=a.sent;case 12:return a.abrupt("return",_.difference(d,e));case 13:return a.abrupt("return",null);case 14:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialBaseConstructor.VERIFY_LEVELS=VERIFY_LEVELS,VerifiableCredentialBaseConstructor.nonCryptographicallySecureVerify=nonCryptographicallySecureVerify,VerifiableCredentialBaseConstructor.cryptographicallySecureVerify=cryptographicallySecureVerify,VerifiableCredentialBaseConstructor.requesterGrantVerify=requesterGrantVerify,module.exports=VerifiableCredentialBaseConstructor;