"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));function _createSuper(a){var b=_isNativeReflectConstruct();return function(){var c,d=(0,_getPrototypeOf2.default)(a);if(b){var e=(0,_getPrototypeOf2.default)(this).constructor;c=Reflect.construct(d,arguments,e)}else c=d.apply(this,arguments);return(0,_possibleConstructorReturn2.default)(this,c)}}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(a){return!1}}var _=require("lodash"),VerifiableCredential=require("./VerifiableCredential"),_require=require("../schemas/jsonSchema"),schemaLoader=_require.schemaLoader,CredentialSignerVerifier=require("./CredentialSignerVerifier"),definitions=schemaLoader.credentialDefinitions;function getCredentialDefinition(a,b){var c=_.find(definitions,{identifier:a});if(!c)throw new Error("Credential definition for ".concat(a," v").concat(b," not found"));return c}function verifyRequiredClaimsFromJSON(a,b){var c=_.get(b,"proof.leaves");if(!_.isEmpty(a.required)&&c){var d=c.map(function(a){return a.identifier}),e=_.difference(a.required,d);if(!_.isEmpty(e))throw new Error("Missing required claim(s): ".concat(_.join(e,", ")))}}var VerifiableCredentialProxy=function(a){function b(a,d,e,f,g,h){var i,j=6<arguments.length&&void 0!==arguments[6]?arguments[6]:null;return(0,_classCallCheck2.default)(this,b),i=c.call(this,a,d,e,null,f,h,j),i.version=g,i.toJSON=function(){var a={id:_.clone(i.id),identifier:_.clone(i.identifier),issuer:_.clone(i.issuer),issuanceDate:_.clone(i.issuanceDate),expirationDate:_.clone(i.expirationDate),version:_.clone(i.version),type:["Credential",i.identifier],claim:_.clone(i.credentialSubject),proof:_.clone(i.proof)};return a.claim&&delete a.claim.id,a},i.verifyMerkletreeSignature=function(a){if(_.isEmpty(a))return!1;var b=new CredentialSignerVerifier({pubBase58:a});return b.isSignatureValid((0,_assertThisInitialized2.default)(i))},i}(0,_inherits2.default)(b,a);var c=_createSuper(b);return(0,_createClass2.default)(b,[{key:"claim",get:function(){return this.credentialSubject}},{key:"granted",get:function(){return this.proof&&this.proof.granted?this.proof.granted:null},set:function(a){this.proof.granted=a}}]),b}(VerifiableCredential);VerifiableCredentialProxy.create=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function g(a,b,c,d,e,f){var h,i,j,k=arguments;return _regenerator.default.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return h=6<k.length&&void 0!==k[6]?k[6]:null,g.next=3,schemaLoader.loadSchemaFromTitle(a);case 3:if(i=g.sent,h&&(j={signer:h}),!(i&&i.properties.credentialSubject)){g.next=7;break}return g.abrupt("return",VerifiableCredential.create(a,b,c,"",d,f,j));case 7:return g.next=9,schemaLoader.loadSchemaFromTitle("cvc:Meta:issuer");case 9:return g.next=11,schemaLoader.loadSchemaFromTitle("cvc:Meta:issuanceDate");case 11:return g.next=13,schemaLoader.loadSchemaFromTitle("cvc:Meta:expirationDate");case 13:return g.next=15,schemaLoader.loadSchemaFromTitle("cvc:Random:node");case 15:return g.abrupt("return",new VerifiableCredentialProxy(a,b,c,d,e,f,j));case 16:case"end":return g.stop();}},g)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialProxy.fromJSON=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d,e,f,g,h=arguments;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=!!(1<h.length&&void 0!==h[1])&&h[1],b.next=3,schemaLoader.loadSchemaFromTitle(a.identifier);case 3:return d=b.sent,b.next=6,schemaLoader.flattenCredentialSchemaProperties(d);case 6:if(e=b.sent,!e.credentialSubject){b.next=9;break}return b.abrupt("return",VerifiableCredential.fromJSON(a));case 9:return b.next=11,VerifiableCredentialProxy.create(a.identifier,a.issuer);case 11:return f=b.sent,f.id=_.clone(a.id),f.issuanceDate=_.clone(a.issuanceDate),f.expirationDate=_.clone(a.expirationDate),f.identifier=_.clone(a.identifier),f.version=_.clone(a.version),f.type=["VerifiableCredential","IdentityCredential"],f.credentialSubject=_.cloneDeep(a.claim),f.proof=_.cloneDeep(a.proof),c||(g=getCredentialDefinition(a.identifier,a.version),verifyRequiredClaimsFromJSON(g,a)),b.abrupt("return",f);case 22:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialProxy.nonCryptographicallySecureVerify=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,VerifiableCredentialProxy.fromJSON(a);case 2:return c=b.sent,b.abrupt("return",VerifiableCredential.nonCryptographicallySecureVerify(c));case 4:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialProxy.cryptographicallySecureVerify=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function d(a,b,c){var e;return _regenerator.default.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return d.next=2,VerifiableCredentialProxy.fromJSON(a);case 2:return e=d.sent,d.abrupt("return",VerifiableCredential.cryptographicallySecureVerify(e,b,c));case 4:case"end":return d.stop();}},d)}));return function(){return a.apply(this,arguments)}}(),VerifiableCredentialProxy.requesterGrantVerify=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(a,b,c,d){var f;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,VerifiableCredentialProxy.fromJSON(a);case 2:return f=e.sent,e.abrupt("return",VerifiableCredential.requesterGrantVerify(f,b,c,d));case 4:case"end":return e.stop();}},e)}));return function(){return a.apply(this,arguments)}}(),module.exports=VerifiableCredentialProxy;