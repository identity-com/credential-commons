"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),uuid=require("uuid/v4"),_require=require("bitcoinjs-lib"),HDNode=_require.HDNode,ECSignature=_require.ECSignature,sjcl=require("sjcl"),logger=require("../logger");function DummyAnchorServiceImpl(a,b){var c=this;this.config=a,this.http=b;var d=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var e;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,c.http.request({url:a,method:"GET",simple:!0,json:!0});case 3:if(e=b.sent,e&&e.type){b.next=8;break}return b.next=7,d(a);case 7:return b.abrupt("return",b.sent);case 8:if(!(e&&"permanent"!==e.type)){b.next=11;break}return e.statusUrl=a,b.abrupt("return",e);case 11:return b.abrupt("return",e);case 14:throw b.prev=14,b.t0=b["catch"](0),logger.error("Error polling: ".concat(a),JSON.stringify(b.t0,null,2)),new Error("Error polling: ".concat(a));case 18:case"end":return b.stop();}},b,null,[[0,14]])}));return function(){return a.apply(this,arguments)}}();return this.anchor=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(){var b,c=arguments;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b=0<c.length&&void 0!==c[0]?c[0]:{},a.abrupt("return",Promise.resolve({subject:{pub:"xpub:dummy",label:b.subject&&b.subject.label?b.subject.label:null,data:b.subject&&b.subject.data?b.subject.data:null,signature:"signed:dummy"},walletId:"none",cosigners:[{pub:"xpub:dummy"},{pub:"xpub:dummy"}],authority:{pub:"xpub:dummy",path:"/"},coin:"dummycoin",tx:uuid(),network:"dummynet",type:"temporary",civicAsPrimary:!1,schema:"dummy-20180201"}));case 2:case"end":return a.stop();}},a)})),this.update=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return a.type="permanent",a.value=new uuid,b.abrupt("return",Promise.resolve(a));case 3:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),this.verifySignature=function(a,b){var d=a.anchor.subject,e=c.verifySubjectSignature(d,b);return e&&d.data===a.merkleRoot},this.verifySubjectSignature=function(a,b){var c=JSON.stringify({xpub:a.pub,label:a.label,data:a.data}),d=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(c)),e=ECSignature.fromDER(Buffer.from(a.signature,"hex"));return HDNode.fromBase58(b||a.pub).keyPair.verify(Buffer.from(d,"hex"),e)},this.verifyAttestation=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var d,e,f,g,h,i=arguments;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return d=!(1<i.length&&void 0!==i[1])||i[1],e="/proof",f="".concat(c.config.attestationService).concat(e),g={url:f,body:{attestation:a.anchor,offline:d},method:"POST",json:!0,simple:!0},b.next=6,c.http.request(g);case 6:return h=b.sent,b.abrupt("return",h.valid);case 8:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),this.revokeAttestation=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return a.revoked=!0,b.abrupt("return",Promise.resolve(a));case 2:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),this.isRevoked=function(a){return!!a.revoked&&a.revoked},this}module.exports={CurrentCivicAnchor:DummyAnchorServiceImpl};