"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_=require("lodash"),Ajv=require("ajv").default,traverse=require("json-schema-traverse"),addFormats=require("ajv-formats").default,definitions=require("../../claim/definitions"),credentialDefinitions=require("../../creds/definitions"),summaryMap={},SummaryMapper=function(){function a(){(0,_classCallCheck2.default)(this,a)}return(0,_createClass2.default)(a,null,[{key:"addDefinition",value:function(b){var c=a.getTextLabel(b.identifier);if(c){var d=_.get(summaryMap,c);d?d.labelFor.push(b.identifier):summaryMap[c]={identifier:b.identifier,textLabel:c,credentials:a.getCredentials(b.identifier),labelFor:[b.identifier],changeable:a.isUpdatable(c),claimPath:a.getClaimPath(b.identifier)}}}},{key:"addCredentialDefinition",value:function(b){var c=a.getTextLabel(b.identifier);c&&(summaryMap[c]={identifier:b.identifier,textLabel:c,credentials:[b.identifier],labelFor:[b.identifier],changeable:a.isUpdatable(c),claimPath:null})}},{key:"getTextLabel",value:function(a){var b=_.split(a,"-"),c=(0,_slicedToArray2.default)(b,3),d=c[0],e=c[1],f=c[2],g=_.split(e,":"),h=(0,_slicedToArray2.default)(g,3),i=h[0],j=h[1],k=h[2];return d&&j?"".concat(j,".").concat(d).concat(k?".".concat(k):"").toLowerCase():null}},{key:"isUpdatable",value:function(a){return!_.includes(["document.placeofbirth.claim","document.dateofbirth.claim"],a)}},{key:"getCredentials",value:function(a){var b=_.split(a,"-"),c=(0,_slicedToArray2.default)(b,3),d=c[0],e=c[1],f=c[2];if("credential"===d)return[a];var g=_.filter(credentialDefinitions,function(b){return _.includes(b.depends,a)});return _.map(g,function(a){return a.identifier})}},{key:"getClaimPath",value:function(b){var c=_.split(b,"-"),d=(0,_slicedToArray2.default)(c,3),e=d[0],f=d[1],g=d[2];return"credential"===e?null:a.getPath(b)}},{key:"getBaseIdentifiers",value:function(a){var b=!0,c=/claim-cvc:(.*)\.(.*)-v\d*/.exec(a);return null===c&&(c=_.split(a,":"),b=!1),{identifierComponents:c,isNewIdentifier:b}}},{key:"getPath",value:function(b){var c=a.getBaseIdentifiers(b),d=c.identifierComponents,e=_.camelCase(d[1]);return"type"===e?d[2]:"".concat(e,".").concat(d[2])}}]),a}(),getSchemaVersion=function(a){var b=a.match(/D-v([\d]+$)/);return b&&1<b.length?b[1]:"1"};function transformUcaIdToClaimId(a){var b=a.split(":");return"claim-cvc:".concat(b[1],".").concat(b[2],"-v1")}function isDefinitionEqual(a,b){return a.identifier===transformUcaIdToClaimId(b)||a.identifier===b}var SchemaLoader=function(){function a(){(0,_classCallCheck2.default)(this,a),this.loaders=[],this.definitions=definitions,this.credentialDefinitions=credentialDefinitions,this.summaryMap=summaryMap,this.validIdentifiers=[],this.validCredentialIdentifiers=[],this.ucaCompared=[],this.ajv=new Ajv({logger:console,allErrors:!0,verbose:!0}),addFormats(this.ajv),this.ajv.addKeyword("attestable"),this.ajv.addKeyword("transient"),this.ajv.addKeyword("credentialItem"),this.ajv.addKeyword("alias"),this.ajv.addKeyword("deambiguify")}return(0,_createClass2.default)(a,[{key:"reset",value:function(){this.definitions.length=0,this.credentialDefinitions.length=0,this.validIdentifiers.length=0,this.validCredentialIdentifiers.length=0,this.ajv.removeSchema(/.*/),summaryMap={},this.summaryMap=summaryMap}},{key:"addLoader",value:function(a){this.loaders.push(a)}},{key:"loadSchemaFromUri",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=b.split("#")[0].match("[^/]+$",b),a.next=3,this.loadSchemaFromTitle(c[0]);case 3:return d=a.sent,a.abrupt("return",d);case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"loadPropertySchema",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c,d,e){var f;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.loadSchemaFromUri(d);case 2:f=a.sent,null!==f&&c.depends.push(f.title),b.properties.claim.required&&b.properties.claim.required.includes(e)&&c.required.push(f.title);case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!/^credential-/.test(b.title)){a.next=5;break}return a.next=3,this.addCredentialDefinition(b);case 3:a.next=7;break;case 5:return a.next=7,this.addClaimDefinition(b);case 7:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addCredentialDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c={identifier:b.title,version:getSchemaVersion(b.title),depends:[]},b.transient&&(c.transient=!0),b.properties.claim.required&&(c.required=[]),d=[],_.forEach(b.properties.claim.properties,function(a){_.forEach(a.properties,function(b,c){d.push({ref:a.properties[c].$ref,property:c})})}),a.next=7,_.reduce(d,function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(d,f){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,d;case 2:return a.abrupt("return",e.loadPropertySchema(b,c,f.ref,f.property));case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Promise.resolve());case 7:this.credentialDefinitions.push(c),this.validCredentialIdentifiers.push(c.identifier),SummaryMapper.addCredentialDefinition(c);case 10:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"shouldAddClaimDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!/^[^:]+:[^:]+:[^:]+$/.test(b.title)){a.next=10;break}if(c=transformUcaIdToClaimId(b.title),this.ucaCompared.includes(b.title)){a.next=5;break}return a.next=5,this.loadSchemaFromTitle(c);case 5:if(this.ucaCompared.push(b.title),d=!1,this.definitions.some(function(a){return isDefinitionEqual(a,b.title)&&(d=!0),d}),!d){a.next=10;break}return a.abrupt("return",!1);case 10:return a.abrupt("return",!0);case 11:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addClaimDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.shouldAddClaimDefinition(b);case 2:if(a.sent){a.next=4;break}return a.abrupt("return");case 4:return a.t0=b.title,a.t1=getSchemaVersion(b.title),a.next=8,this.findDefinitionType(b);case 8:if(a.t2=a.sent,c={identifier:a.t0,version:a.t1,type:a.t2},"Array"!==c.type){a.next=15;break}return a.next=13,this.loadSchemaFromUri(b.items.$ref);case 13:d=a.sent,c.items={type:d.title};case 15:["attestable","credentialItem","minimum","maximum","alias","description"].forEach(function(a){a in b&&(c[a]=b[a])}),b.pattern&&(c.pattern=new RegExp(b.pattern)),b.required&&(c.type.required=b.required),b.enum&&(c.enum={},_.forEach(b.enum,function(a){c.enum[a.toUpperCase()]=a})),this.definitions.push(c),this.validIdentifiers.push(b.title),SummaryMapper.addDefinition(c);case 22:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPropertyValue",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c,d){var e,f,g,h,i,j;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(e=c.deambiguify,f=c.items,g=c.type,!("array"===g||f&&f.$ref)){a.next=11;break}if(!f.$ref){a.next=10;break}return a.next=6,this.loadSchemaFromUri(f.$ref);case 6:h=a.sent,g=h.title,a.next=11;break;case 10:g=_.capitalize(g);case 11:if(!c.allOf){a.next=16;break}return a.next=14,this.loadSchemaFromUri(c.allOf[0].$ref);case 14:i=a.sent,g=i.title;case 16:j={name:d,type:g},e&&(j.deambiguify=e),b.push(j);case 19:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPropertyValues",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=[],a.next=3,_.reduce(b,function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,e,f){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b;case 2:return a.abrupt("return",d.getPropertyValue(c,e,f));case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Promise.resolve());case 3:return a.abrupt("return",{properties:c});case 4:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}()},{key:"findDefinitionType",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!b.allOf){a.next=7;break}return a.next=3,this.loadSchemaFromUri(b.allOf[0].$ref);case 3:if(c=a.sent,null!=c){a.next=6;break}return a.abrupt("return",null);case 6:return a.abrupt("return",c.title);case 7:if("object"!==b.type){a.next=13;break}if(_.isEmpty(b.properties)){a.next=13;break}return a.next=11,this.getPropertyValues(b.properties);case 11:return d=a.sent,a.abrupt("return",d);case 13:if("array"!==b.type){a.next=15;break}return a.abrupt("return","Array");case 15:return a.abrupt("return",_.capitalize(b.type));case 16:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"loadSchemaFromTitle",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e,f,g,h=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=this.findSchemaLoader(b),null!=c){a.next=3;break}return a.abrupt("return",null);case 3:if(d=c.schemaId(b),e=this.ajv.getSchema(d),e){a.next=25;break}return a.next=8,c.loadSchema(b);case 8:if(f=a.sent,null!==f){a.next=11;break}return a.abrupt("return",null);case 11:return g=[],traverse(f,{cb:function(a){void 0!==a.$ref&&g.push(h.loadSchemaFromUri(a.$ref))}}),a.next=15,Promise.all(g);case 15:a.prev=15,this.ajv.addSchema(f),a.next=22;break;case 19:return a.prev=19,a.t0=a["catch"](15),a.abrupt("return",f);case 22:return a.next=24,this.addDefinition(f);case 24:return a.abrupt("return",f);case 25:return a.abrupt("return",e.schema);case 26:case"end":return a.stop();}},a,this,[[15,19]])}));return function(){return a.apply(this,arguments)}}()},{key:"findSchemaLoader",value:function(a){return _.find(this.loaders,function(b){return b.valid(a)})}},{key:"validateSchema",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return d=this.findSchemaLoader(b),a.next=3,this.loadSchemaFromTitle(b);case 3:this.validate(d.schemaId(b),c);case 4:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"validate",value:function(a,b){var c=this.ajv.getSchema(a);if("undefined"==typeof c)throw new Error("Invalid schema id: ".concat(a));var d=c(b);if(!d)throw _.forEach(c.errors,function(a){if(a.params&&a.params.missingProperty)throw new Error("Missing required fields to ".concat(c.schema.title))}),new Error("Invalid value. Errors: ".concat(JSON.stringify(c.errors,null,2)))}}]),a}(),schemaLoader=new SchemaLoader;module.exports={schemaLoader:schemaLoader};