"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){(0,_defineProperty2.default)(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}var _=require("lodash"),Ajv=require("ajv").default,traverse=require("json-schema-traverse"),_require=require("@identity.com/uca"),ucaDefinitions=_require.definitions,addFormats=require("ajv-formats").default,definitions=require("../../claim/definitions"),credentialDefinitions=require("../../creds/definitions"),summaryMap={},SummaryMapper=function(){function a(){(0,_classCallCheck2.default)(this,a)}return(0,_createClass2.default)(a,null,[{key:"addDefinition",value:function(b){var c=a.getTextLabel(b.identifier);if(c){var d=_.get(summaryMap,c);d?d.labelFor.push(b.identifier):summaryMap[c]={identifier:b.identifier,textLabel:c,credentials:a.getCredentials(b.identifier),labelFor:[b.identifier],changeable:a.isUpdatable(c),claimPath:a.getClaimPath(b.identifier)}}}},{key:"addCredentialDefinition",value:function(b){var c=a.getTextLabel(b.identifier);c&&(summaryMap[c]={identifier:b.identifier,textLabel:c,credentials:[b.identifier],labelFor:[b.identifier],changeable:a.isUpdatable(c),claimPath:null})}},{key:"getTextLabel",value:function(a){var b=_.split(a,"-"),c=(0,_slicedToArray2.default)(b,3),d=c[0],e=c[1],f=c[2],g=_.split(e,":"),h=(0,_slicedToArray2.default)(g,3),i=h[0],j=h[1],k=h[2];return d&&j?"".concat(j,".").concat(d).concat(k?".".concat(k):"").toLowerCase():null}},{key:"isUpdatable",value:function(a){return!_.includes(["document.placeofbirth.claim","document.dateofbirth.claim"],a)}},{key:"getCredentials",value:function(a){var b=_.split(a,"-"),c=(0,_slicedToArray2.default)(b,3),d=c[0],e=c[1],f=c[2];if("credential"===d)return[a];var g=_.filter(credentialDefinitions,function(b){return _.includes(b.depends,a)});return _.map(g,function(a){return a.identifier})}},{key:"getClaimPath",value:function(b){var c=_.split(b,"-"),d=(0,_slicedToArray2.default)(c,3),e=d[0],f=d[1],g=d[2];return"credential"===e?null:a.getPath(b)}},{key:"getBaseIdentifiers",value:function(a){var b=!0,c=/claim-cvc:(.*)\.(.*)-v\d*/.exec(a);return null===c&&(c=_.split(a,":"),b=!1),{identifierComponents:c,isNewIdentifier:b}}},{key:"getPath",value:function(b){var c=a.getBaseIdentifiers(b),d=c.identifierComponents,e=_.camelCase(d[1]);return"type"===e?d[2]:"".concat(e,".").concat(d[2])}}]),a}(),getSchemaVersion=function(a){var b=a.match(/-v([\d]+$)/);return b&&1<b.length?b[1]:"1"};function transformUcaIdToClaimId(a){var b=a.split(":");return"claim-cvc:".concat(b[1],".").concat(b[2],"-v1")}function isDefinitionEqual(a,b){return a.identifier===transformUcaIdToClaimId(b)||a.identifier===b}var isUCA=function(a){return /^[^:]+:[^:]+:[^:]+$/.test(a)},SchemaLoader=function(){function a(){(0,_classCallCheck2.default)(this,a),this.loaders=[],this.definitions=definitions,this.ucaDefinitions=ucaDefinitions,this.credentialDefinitions=credentialDefinitions,this.summaryMap=summaryMap,this.validIdentifiers=[],this.validUcaIdentifiers=[],this.validCredentialIdentifiers=[],this.ucaCompared=[],this.ajv=new Ajv({logger:console,allErrors:!0,verbose:!0,strict:!0,allowUnionTypes:!0}),addFormats(this.ajv),this.ajv.addKeyword("attestable"),this.ajv.addKeyword("transient"),this.ajv.addKeyword("credentialItem"),this.ajv.addKeyword("alias"),this.ajv.addKeyword("deambiguify")}return(0,_createClass2.default)(a,[{key:"reset",value:function(){this.ucaDefinitions.length=0,this.definitions.length=0,this.credentialDefinitions.length=0,this.validIdentifiers.length=0,this.validCredentialIdentifiers.length=0,this.validUcaIdentifiers.length=0,this.ajv.removeSchema(/.*/),summaryMap={},this.summaryMap=summaryMap}},{key:"addLoader",value:function(a){this.loaders.push(a)}},{key:"loadSchemaFromUri",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=a.split("#")[0].match("[^/]+$",a),b.next=3,this.loadSchemaFromTitle(c[0]);case 3:return d=b.sent,b.abrupt("return",d);case 5:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"loadPropertySchema",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(a,b,c,d){var f,g;return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.loadSchemaFromUri(c);case 2:return f=e.sent,null!==f&&b.depends.push(f.title),e.next=6,this.getCredentialSubjectProperties(a);case 6:g=e.sent,g.required&&g.required.includes(d)&&b.required.push(f.title);case 8:case"end":return e.stop();}},e,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getCredentialSubjectProperties",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,this.flattenCredentialSchemaProperties(a);case 2:return c=b.sent,b.abrupt("return",c.credentialSubject?c.credentialSubject:c.claim);case 4:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"flattenCredentialSchemaProperties",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d,e=this;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(c=a.properties?a.properties:{},!a.allOf){b.next=5;break}return d=a.allOf.map(function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var d,f;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(!a.$ref){b.next=8;break}return b.next=3,e.loadSchemaFromUri(a.$ref);case 3:return d=b.sent,b.next=6,e.flattenCredentialSchemaProperties(d);case 6:f=b.sent,c=_objectSpread(_objectSpread({},c),f);case 8:a.properties&&(c=_objectSpread(_objectSpread({},c),a.properties));case 9:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}()),b.next=5,Promise.all(d);case 5:return b.abrupt("return",c);case 6:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}()},{key:"addDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(!/^credential-/.test(a.title)){b.next=5;break}return b.next=3,this.addCredentialDefinition(a);case 3:b.next=7;break;case 5:return b.next=7,this.addClaimDefinition(a);case 7:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addCredentialDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d,e,f=this;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c={identifier:a.title,version:getSchemaVersion(a.title),depends:[]},a.transient&&(c.transient=!0),b.next=4,this.getCredentialSubjectProperties(a);case 4:return d=b.sent,d.required&&(c.required=[]),e=[],_.forEach(d.properties,function(a){_.forEach(a.properties,function(b,c){e.push({ref:a.properties[c].$ref,property:c})})}),b.next=10,_.reduce(e,function(){var b=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function e(b,d){return _regenerator.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b;case 2:return e.abrupt("return",f.loadPropertySchema(a,c,d.ref,d.property));case 3:case"end":return e.stop();}},e)}));return function(){return b.apply(this,arguments)}}(),Promise.resolve());case 10:this.credentialDefinitions.push(c),this.validCredentialIdentifiers.push(c.identifier),SummaryMapper.addCredentialDefinition(c);case 13:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"shouldAddClaimDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(!isUCA(a.title)){b.next=10;break}if(c=transformUcaIdToClaimId(a.title),this.ucaCompared.includes(a.title)){b.next=5;break}return b.next=5,this.loadSchemaFromTitle(c);case 5:if(this.ucaCompared.push(a.title),d=!1,this.definitions.some(function(b){return isDefinitionEqual(b,a.title)&&(d=!0),d}),!d){b.next=10;break}return b.abrupt("return",!1);case 10:return b.abrupt("return",!0);case 11:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"addClaimDefinition",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.t0=a.title,b.t1=getSchemaVersion(a.title),b.next=4,this.findDefinitionType(a);case 4:if(b.t2=b.sent,c={identifier:b.t0,version:b.t1,type:b.t2},"Array"!==c.type){b.next=11;break}return b.next=9,this.loadSchemaFromUri(a.items.$ref);case 9:d=b.sent,c.items={type:d.title};case 11:return["attestable","credentialItem","minimum","maximum","alias","description"].forEach(function(b){b in a&&(c[b]=a[b])}),a.pattern&&(c.pattern=new RegExp(a.pattern)),a.required&&(c.type.required=a.required),a.enum&&(c.enum={},_.forEach(a.enum,function(a){c.enum[a.toUpperCase()]=a})),b.next=17,this.shouldAddClaimDefinition(a);case 17:if(!b.sent){b.next=20;break}this.definitions.push(c),this.validIdentifiers.push(a.title);case 20:isUCA(a.title)&&(this.ucaDefinitions.push(c),this.validUcaIdentifiers.push(a.title)),SummaryMapper.addDefinition(c);case 22:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPropertyValue",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function d(a,b,c){var e,f,g,h,i,j;return _regenerator.default.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(e=b.deambiguify,f=b.items,g=b.type,!("array"===g||f&&f.$ref)){d.next=11;break}if(!f.$ref){d.next=10;break}return d.next=6,this.loadSchemaFromUri(f.$ref);case 6:h=d.sent,g=h.title,d.next=11;break;case 10:g=_.capitalize(g);case 11:if(!b.allOf){d.next=16;break}return d.next=14,this.loadSchemaFromUri(b.allOf[0].$ref);case 14:i=d.sent,g=i.title;case 16:j={name:c,type:g},e&&(j.deambiguify=e),a.push(j);case 19:case"end":return d.stop();}},d,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPropertyValues",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d=this;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return c=[],b.next=3,_.reduce(a,function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function f(a,b,e){return _regenerator.default.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return f.next=2,a;case 2:return f.abrupt("return",d.getPropertyValue(c,b,e));case 3:case"end":return f.stop();}},f)}));return function(){return a.apply(this,arguments)}}(),Promise.resolve());case 3:return b.abrupt("return",{properties:c});case 4:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}()},{key:"findDefinitionType",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(!a.allOf){b.next=7;break}return b.next=3,this.loadSchemaFromUri(a.allOf[0].$ref);case 3:if(c=b.sent,null!=c){b.next=6;break}return b.abrupt("return",null);case 6:return b.abrupt("return",c.title);case 7:if("object"!==a.type){b.next=10;break}if(_.isEmpty(a.properties)){b.next=10;break}return b.abrupt("return",this.getPropertyValues(a.properties));case 10:if("array"!==a.type){b.next=12;break}return b.abrupt("return","Array");case 12:return b.abrupt("return",_.capitalize(a.type));case 13:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"loadSchemaFromTitle",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d,e,f,g,h=this;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(c=this.findSchemaLoader(a),null!=c){b.next=3;break}return b.abrupt("return",null);case 3:if(d=c.schemaId(a),e=this.ajv.getSchema(d),e){b.next=19;break}return b.next=8,c.loadSchema(a);case 8:if(f=b.sent,null!==f){b.next=11;break}return b.abrupt("return",null);case 11:return g=[],traverse(f,{cb:function(a){void 0===a.$ref||a.$ref.startsWith("#")||g.push(h.loadSchemaFromUri(a.$ref))}}),b.next=15,Promise.all(g);case 15:return b.next=17,this.addDefinition(f);case 17:try{this.ajv.addSchema(f)}catch(a){}return b.abrupt("return",f);case 19:return b.abrupt("return",e.schema);case 20:case"end":return b.stop();}},b,this)}));return function(){return a.apply(this,arguments)}}()},{key:"findSchemaLoader",value:function(a){return _.find(this.loaders,function(b){return b.valid(a)})}},{key:"validateSchema",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function c(a,b){var d;return _regenerator.default.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return d=this.findSchemaLoader(a),c.next=3,this.loadSchemaFromTitle(a);case 3:this.validate(d.schemaId(a),b);case 4:case"end":return c.stop();}},c,this)}));return function(){return a.apply(this,arguments)}}()},{key:"validate",value:function(a,b){var c=this.ajv.getSchema(a);if("undefined"==typeof c)throw new Error("Invalid schema id: ".concat(a));var d=c(b);if(!d)throw _.forEach(c.errors,function(a){if(a.params&&a.params.missingProperty)throw new Error("Missing required fields to ".concat(c.schema.title))}),new Error("Invalid value. Errors: ".concat(JSON.stringify(c.errors,null,2)))}}]),a}(),schemaLoader=new SchemaLoader;module.exports={schemaLoader:schemaLoader};