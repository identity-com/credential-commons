"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fs=require("fs"),_require=require("../../../lib/stringUtils"),parseIdentifier=_require.parseIdentifier,_require2=require("../../../services"),services=_require2.services,rootUri="http://identity.com/schemas/",DEFAULT_SCHEMA_PATH="http://dev-schemas.civic.com.s3-website-us-east-1.amazonaws.com/dev",FSSchemaCache=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"./.tmp/schemas";(0,_classCallCheck2.default)(this,a),this.cachePath=b,fs.mkdirSync(b,{recursive:!0})}return(0,_createClass2.default)(a,[{key:"get",value:function(a){var b="".concat(this.cachePath,"/").concat(a,".schema.json");return fs.existsSync(b)?fs.readFileSync(b):null}},{key:"set",value:function(a,b){var c="".concat(this.cachePath,"/").concat(a,".schema.json");fs.writeFileSync(c,b)}}]),a}(),getIdentifierPath=function(a){var b;if(/^cvc:.*$/.test(a))b="uca/1/".concat(a);else{var c=parseIdentifier(a);c&&(b="".concat(c[1],"/").concat(c[4],"/").concat(c[2]))}return b},CVCLoader=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:services.container.Http,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new FSSchemaCache,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:DEFAULT_SCHEMA_PATH;(0,_classCallCheck2.default)(this,a),this.http=b,this.cache=c,this.schemaPath=d}return(0,_createClass2.default)(a,[{key:"schemaId",value:function(a){return rootUri+a}},{key:"valid",value:function(a){return /^(claim|credential|type)-(cvc|alt):.*$/.test(a)||/^cvc:.*$/.test(a)}},{key:"loadSchema",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=null,this.cache&&(c=this.cache.get(b)),c){a.next=7;break}return a.next=5,this.remote(b);case 5:c=a.sent,this.cache&&c&&this.cache.set(b,c);case 7:return a.abrupt("return",c?JSON.parse(c):null);case 8:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"remote",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b){var c,d,e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=getIdentifierPath(b),c){a.next=3;break}return a.abrupt("return",null);case 3:return d="".concat(this.schemaPath,"/").concat(c,".schema.json"),e=null,a.prev=5,a.next=8,this.http.request(d);case 8:e=a.sent,a.next=21;break;case 11:if(a.prev=11,a.t0=a["catch"](5),!(!a.t0.statusCode||500<=a.t0.statusCode&&599>=a.t0.statusCode)){a.next=19;break}return a.next=16,services.container.Http.request(d);case 16:e=a.sent,a.next=21;break;case 19:if(!(400>a.t0.statusCode||500<=a.t0.statusCode)){a.next=21;break}throw a.t0;case 21:return a.abrupt("return",e);case 22:case"end":return a.stop();}},a,this,[[5,11]])}));return function(){return a.apply(this,arguments)}}()}]),a}();module.exports=CVCLoader;