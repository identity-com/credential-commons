"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fs=require("fs"),_require=require("../../../lib/stringUtils"),parseIdentifier=_require.parseIdentifier,_require2=require("../../../services"),services=_require2.services,rootUri="http://identity.com/schemas/",DEFAULT_SCHEMA_PATH="http://dev-schemas.civic.com.s3-website-us-east-1.amazonaws.com/dev",FSSchemaCache=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"./.tmp/schemas";(0,_classCallCheck2.default)(this,a),this.cachePath=b,fs.mkdirSync(b,{recursive:!0})}return(0,_createClass2.default)(a,[{key:"get",value:function(a){var b="".concat(this.cachePath,"/").concat(a,".schema.json");return fs.existsSync(b)?fs.readFileSync(b,{encoding:"utf8"}):null}},{key:"set",value:function(a,b){var c="".concat(this.cachePath,"/").concat(a,".schema.json");fs.writeFileSync(c,b,{encoding:"utf8"})}}]),a}(),getIdentifierPath=function(a){var b;if(/^cvc:.*$/.test(a))b="uca/1/".concat(a);else{var c=parseIdentifier(a);c&&(b="".concat(c[1],"/").concat(c[4],"/").concat(c[2]))}return b},CVCLoader=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:services.container.Http,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new FSSchemaCache,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:DEFAULT_SCHEMA_PATH;(0,_classCallCheck2.default)(this,a),this.http=b,this.cache=c,this.schemaPath=d}return(0,_createClass2.default)(a,[{key:"schemaId",value:function(a){return rootUri+a}},{key:"valid",value:function(a){return /^(claim|credential|type)-(cvc|alt):.*$/.test(a)||/^cvc:.*$/.test(a)}},{key:"loadSchema",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(c=null,this.cache&&(c=this.cache.get(a)),c){b.next=7;break}return b.next=5,this.remote(a);case 5:c=b.sent,this.cache&&c&&this.cache.set(a,c);case 7:return b.prev=7,b.abrupt("return",c?JSON.parse(c):null);case 11:return b.prev=11,b.t0=b["catch"](7),b.abrupt("return",null);case 14:case"end":return b.stop();}},b,this,[[7,11]])}));return function(){return a.apply(this,arguments)}}()},{key:"remote",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d,e;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(c=getIdentifierPath(a),c){b.next=3;break}return b.abrupt("return",null);case 3:return d="".concat(this.schemaPath,"/").concat(c,".schema.json"),e=null,b.prev=5,b.next=8,this.http.request(d);case 8:e=b.sent,b.next=21;break;case 11:if(b.prev=11,b.t0=b["catch"](5),!(!b.t0.statusCode||500<=b.t0.statusCode&&599>=b.t0.statusCode)){b.next=19;break}return b.next=16,services.container.Http.request(d);case 16:e=b.sent,b.next=21;break;case 19:if(!(400>b.t0.statusCode||500<=b.t0.statusCode)){b.next=21;break}throw b.t0;case 21:return b.abrupt("return",e);case 22:case"end":return b.stop();}},b,this,[[5,11]])}));return function(){return a.apply(this,arguments)}}()}]),a}();module.exports=CVCLoader;