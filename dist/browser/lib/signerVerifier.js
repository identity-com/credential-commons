"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),nacl=require("tweetnacl"),bs58=require("bs58"),didUtil=require("./did"),textEncoder=new TextEncoder,Ed25519Signer=function(){function a(b,c){(0,_classCallCheck2.default)(this,a),this.key=b,this.verificationMethod=c}return(0,_createClass2.default)(a,[{key:"sign",value:function(a){var b=nacl.sign.detached(textEncoder.encode(a.merkleRoot),bs58.decode(this.key)),c=Buffer.from(b).toString("hex");return{signature:c,verificationMethod:this.verificationMethod}}}]),a}(),Ed25519Verifier=function(){function a(b){(0,_classCallCheck2.default)(this,a),this.key=b}return(0,_createClass2.default)(a,[{key:"verify",value:function(a){return nacl.sign.detached.verify(textEncoder.encode(a.proof.merkleRoot),Uint8Array.from(Buffer.from(a.proof.merkleRootSignature.signature,"hex")),bs58.decode(this.key))}}]),a}(),signer=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function b(a){var c,d,e,f,g,h,i,j;return _regenerator.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(a.signer||a.keypair||a.privateKey){b.next=2;break}throw new Error("Either a signer, keypair or privateKey is required");case 2:if(c=a.verificationMethod,d=a.signer,!d){b.next=6;break}return b.abrupt("return",d);case 6:return e=c.split("#"),f=(0,_slicedToArray2.default)(e,1),g=f[0],b.next=9,didUtil.resolve(g);case 9:if(h=b.sent,i=a.privateKey,i||(i=bs58.encode(a.keypair.secretKey)),j=didUtil.findVerificationMethod(h,c),j){b.next=15;break}throw new Error("The provided verificationMethod is not valid on the DID document");case 15:b.t0=j.type,b.next="Ed25519VerificationKey2018"===b.t0?18:"Ed25519VerificationKey2020"===b.t0?18:20;break;case 18:return d=new Ed25519Signer(i,c),b.abrupt("break",21);case 20:throw new Error("Unsupported type ".concat(j.type));case 21:return b.abrupt("return",d);case 22:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),verifier=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function c(a,b){var d,e,f,g,h,i;return _regenerator.default.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,didUtil.canSign(a,b);case 2:if(d=c.sent,d){c.next=5;break}return c.abrupt("return",{verify:function(){return!1}});case 5:return e=b.split("#"),f=(0,_slicedToArray2.default)(e,1),g=f[0],c.next=8,didUtil.resolve(g);case 8:h=c.sent,i=didUtil.findVerificationMethod(h,b),c.t0=i.type,c.next="Ed25519VerificationKey2018"===c.t0?13:"Ed25519VerificationKey2020"===c.t0?13:14;break;case 13:return c.abrupt("return",new Ed25519Verifier(i.publicKeyBase58));case 14:throw new Error("Unsupported type ".concat(i.type));case 15:case"end":return c.stop();}},c)}));return function(){return a.apply(this,arguments)}}();module.exports={signer:signer,verifier:verifier};