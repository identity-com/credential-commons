"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_get2=_interopRequireDefault(require("@babel/runtime/helpers/get")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));function _createForOfIteratorHelper(a,b){var c="undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(!c){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function(){c=c.call(a)},n:function(){var a=c.next();return g=a.done,a},e:function(a){h=!0,f=a},f:function(){try{g||null==c.return||c.return()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function _createSuper(a){var b=_isNativeReflectConstruct();return function(){var c,d=(0,_getPrototypeOf2.default)(a);if(b){var e=(0,_getPrototypeOf2.default)(this).constructor;c=Reflect.construct(d,arguments,e)}else c=d.apply(this,arguments);return(0,_possibleConstructorReturn2.default)(this,c)}}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(a){return!1}}var _=require("lodash"),sjcl=require("sjcl"),_require=require("@identity.com/uca"),UserCollectableAttribute=_require.UserCollectableAttribute,_require2=require("../services"),services=_require2.services,definitions=require("./definitions"),_require3=require("../schemas/jsonSchema"),schemaLoader=_require3.schemaLoader,validIdentifiers=schemaLoader.validIdentifiers,findDefinition=function(a,b){return b?_.find(definitions,{identifier:a,version:b}):_.find(definitions,{identifier:a})},getDefinition=function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,schemaLoader.loadSchemaFromTitle(b);case 2:return a.abrupt("return",findDefinition(b,c));case 3:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),isArrayAttestableValue=function(a){return-1<a.indexOf("[")&&-1<a.indexOf("]")};function getBaseIdentifiers(a){var b=!0,c=/^claim-cvc:(.*)\.(.*)-v\d*$/.exec(a);return null===c&&(c=_.split(a,":"),b=!1),{identifierComponents:c,isNewIdentifier:b}}function adaptIdentifierIfNeeded(){return _adaptIdentifierIfNeeded.apply(this,arguments)}function _adaptIdentifierIfNeeded(){return _adaptIdentifierIfNeeded=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d,e,f,g,h,i,j,k;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,getDefinition(b,c);case 2:return d=a.sent,e=d&&d.alias?d.type:b,f=getBaseIdentifiers(e),g=f.isNewIdentifier,h=f.identifierComponents,a.next=7,getDefinition(e,c);case 7:if(i=a.sent,g||i){a.next=16;break}return j="claim-cvc:".concat(h[1],".").concat(h[2],"-v1"),a.next=12,schemaLoader.loadSchemaFromTitle(j);case 12:if(k=_.find(definitions,{identifier:j}),!k){a.next=15;break}return a.abrupt("return",j);case 15:throw new Error("".concat(e," is not defined"));case 16:return a.abrupt("return",b);case 17:case"end":return a.stop();}},a)})),_adaptIdentifierIfNeeded.apply(this,arguments)}var Claim=function(a){function b(a,d,e){var f;return(0,_classCallCheck2.default)(this,b),f=c.call(this,a,d,e,definitions),f.initialize(a,d,e),f}(0,_inherits2.default)(b,a);var c=_createSuper(b);return(0,_createClass2.default)(b,[{key:"initialize",value:function(a,c,d){if((0,_get2.default)((0,_getPrototypeOf2.default)(b.prototype),"initialize",this).call(this,a,c,d),!this.salt){var e=services.container.SecureRandom;this.salt=sjcl.codec.hex.fromBits(sjcl.hash.sha256.hash(e.wordWith(64)))}}},{key:"initializeValuesWithArrayItems",value:function(a,c,d){var e=findDefinition(this.identifier,this.version),f=[];if(!_.isArray(c))throw new Error("Value for ".concat(a,"-").concat(d," should be an array"));_.forEach(c,function(a){var c=new b(_.get(e,"items.type"),a);f.push(c)}),this.value=f}},{key:"initializeAttestableValue",value:function(){var a=this,c=this.value,d=findDefinition(this.identifier,this.version),e=b.parseAttestableValue(c);if(1===e.length){this.timestamp=null,this.salt=e[0].salt;var f=e[0].value;this.value="Array"===d.type?_.map(f,function(a){return new b(d.items.type,{attestableValue:a})}):this.value=_.includes(["null","undefined"],f)?null:f}else{for(var g={},h=function(c){var f=e[c].propertyName,h=void 0,i=void 0,j=UserCollectableAttribute.resolveType(d,definitions),k=j.properties.find(function(a){return a.name===f});if(k)h=k.type,i=f;else{var l=f.split("."),m=l[l.length-2],n=m.substring(0,1).toUpperCase()+m.substring(1);i=l[l.length-1],h="cvc:".concat(n,":").concat(i)}var o=definitions.find(function(a){return a.identifier===h});o||(h=a.findDefinitionByAttestableValue(i,d)),g[f]=new b(h,{attestableValue:e[c].stringValue})},j=0;j<e.length;j+=1)h(j);this.value=g}}},{key:"getValidIdentifiers",value:function(){return validIdentifiers}},{key:"findDefinitionByAttestableValue",value:function(a,b){var c,d=UserCollectableAttribute.resolveType(b,definitions),e=_createForOfIteratorHelper(d.properties);try{for(e.s();!(c=e.n()).done;){var f=c.value,g=_.find(definitions,{identifier:f.type});if(g.type=UserCollectableAttribute.resolveType(g,definitions),!g.type.properties&&f.name===a)return f.type;if(g.type.properties)return this.findDefinitionByAttestableValue(a,g)}}catch(a){e.e(a)}finally{e.f()}return null}},{key:"getAttestableValue",value:function(a){var b=this,c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=getBaseIdentifiers(this.identifier),e=d.identifierComponents,f=e[2];if(c&&(f=null),a&&(f="".concat(a,".").concat(f)),0<=["String","Number","Boolean"].indexOf(this.type))return"urn:".concat(f,":").concat(this.salt,":").concat(this.value,"|");if("Array"===this.type){var g=_.reduce(this.value,function(a,b){return"".concat(a).concat(b.getAttestableValue(null,!0),",")},"");return"urn:".concat(f,":").concat(this.salt,":[").concat(g,"]")}return _.reduce(_.sortBy(_.keys(this.value)),function(a,c){return"".concat(a).concat(b.value[c].getAttestableValue(f))},"")}},{key:"getGlobalIdentifier",value:function(){return"claim-".concat(this.identifier,"-").concat(this.version)}},{key:"getClaimRootPropertyName",value:function(){var a=getBaseIdentifiers(this.identifier),b=a.identifierComponents;return"type"===b[1].toLowerCase()?"":_.camelCase(b[1])}},{key:"getClaimPropertyName",value:function(){var a=getBaseIdentifiers(this.identifier),b=a.identifierComponents;return b[2]}},{key:"getClaimPath",value:function(){return b.getPath(this.identifier)}},{key:"getAttestableValues",value:function(a){var b=this,c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],d=function(a,b){var c=a?_.split(a,"."):[],d=b?_.split(b,"."):[];d=_.last(c)===_.first(d)?d.splice(1):d;var e=_.join([].concat((0,_toConsumableArray2.default)(c),(0,_toConsumableArray2.default)(d)),".");return e},e=[],f=_.find(definitions,{identifier:this.identifier,version:this.version});if(f.credentialItem||f.attestable){var g=d(a,c?null:this.getClaimPath());e.push({identifier:this.identifier,value:this.getAttestableValue(null,c),claimPath:g}),"Object"===this.type?_.forEach(_.keys(this.value),function(a){var c=b.value[a].getAttestableValues(g);e=_.concat(e,c)}):"Array"===this.type&&_.forEach(this.value,function(a,b){var c;(c=e).push.apply(c,(0,_toConsumableArray2.default)(a.getAttestableValues("".concat(g,".").concat(b),!0)))})}return e}}],[{key:"create",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(c,d,e){var f,g;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,adaptIdentifierIfNeeded(c,e);case 2:if(f=a.sent,d.attestableValue){a.next=6;break}return a.next=6,schemaLoader.validateSchema(f,d);case 6:return a.next=8,schemaLoader.loadSchemaFromTitle(f);case 8:return g=new b(f,d,e),a.abrupt("return",g);case 10:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}()},{key:"resolveType",value:function(a){return UserCollectableAttribute.resolveType(a,definitions)}},{key:"parseAttestableArrayValue",value:function(a){var c=a.attestableValue.split(":"),d=c[1],e=c[2],f=a.attestableValue.substring(a.attestableValue.indexOf("[")+1,a.attestableValue.indexOf("]")-1).split(","),g=_.map(f,function(a){return b.parseAttestableValue({attestableValue:a})});return{propertyName:d,salt:e,value:g}}},{key:"parseAttestableValue",value:function(a){var c=[];if(_.isArray(a.attestableValue))return a.attestableValue;if(isArrayAttestableValue(a.attestableValue)){var d=b.parseAttestableArrayValue(a);return[d]}var e=_.split(a.attestableValue,"|");if(_.each(e,function(a){var b=/^urn:(\w+(?:\.\w+)*):(\w+):(.+)/.exec(a);if(b&&4===b.length){var d={propertyName:b[1],salt:b[2],value:b[3],stringValue:a};c.push(d)}}),e.length!==c.length&&e.length!==c.length+1)throw new Error("Invalid attestableValue");return c}},{key:"getPath",value:function(a){var b=getBaseIdentifiers(a),c=b.identifierComponents,d=_.camelCase(c[1]);return"type"===d?c[2]:"".concat(d,".").concat(c[2])}},{key:"getTypeName",value:function(a){if(_.isString(a.type)){if(_.includes(validIdentifiers,a.type)){var b=_.find(definitions,{identifier:a.type});return this.getTypeName(b)}return a.type}return"Object"}},{key:"getAllProperties",value:function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,schemaLoader.loadSchemaFromTitle(b);case 2:if(d=_.find(definitions,{identifier:b}),e=[],f=UserCollectableAttribute.resolveType(d,definitions),g=_.isString(f)?_.find(definitions,{identifier:f}):d,!(g&&"Object"===this.getTypeName(g))){a.next=20;break}if(g.type.properties?h=g.type.properties:(i=_.find(definitions,{identifier:g.type}),h=UserCollectableAttribute.resolveType(i,definitions).properties),k=getBaseIdentifiers(b),l=k.identifierComponents,j=c?_.includes(c,_.lowerCase(l[1]))?"".concat(c):"".concat(c,".").concat(_.lowerCase(l[1]),".").concat(l[2]):"".concat(_.lowerCase(l[1]),".").concat(l[2]),!_.includes(["String","Number","Boolean"],"".concat(h.type))){a.next=14;break}e.push("".concat(j,".").concat(h.name)),a.next=18;break;case 14:return a.next=16,h.reduce(function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function a(b,c){var d,e,f,g,h;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b;case 2:return d=a.sent,e=getBaseIdentifiers(c.type),f=e.isNewIdentifier,g=f?"".concat(j,".").concat(c.name):j,a.next=7,t.getAllProperties(c.type,g);case 7:return h=a.sent,a.abrupt("return",[].concat((0,_toConsumableArray2.default)(d),(0,_toConsumableArray2.default)(h)));case 9:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),Promise.resolve([]));case 16:m=a.sent,e.push.apply(e,(0,_toConsumableArray2.default)(m));case 18:a.next=21;break;case 20:c?(n=getBaseIdentifiers(d.identifier),o=n.identifierComponents,p=0<=c.indexOf(o[2])?"".concat(c):"".concat(c,".").concat(o[2]),e.push(p)):(q=getBaseIdentifiers(b),r=q.identifierComponents,s="".concat(_.lowerCase(r[1]),".").concat(r[2]),e.push(s));case 21:return a.abrupt("return",e);case 22:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()}]),b}(UserCollectableAttribute);function convertIdentifierToClassName(a){var b=getBaseIdentifiers(a),c=b.identifierComponents,d=c[1],e=_.upperFirst(_.camelCase(c[2]));return"".concat(d).concat(e)}function mixinIdentifiers(a){return _.forEach(_.filter(definitions,function(a){return a.credentialItem}),function(a){var b=convertIdentifierToClassName(a.identifier),c={},d=a.identifier;c[b]=function(a,b){return new Claim(d,a,b)},_.mixin(Claim,c)}),a}module.exports={Claim:mixinIdentifiers(Claim),definitions:definitions,getBaseIdentifiers:getBaseIdentifiers};